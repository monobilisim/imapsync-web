<!DOCTYPE html>

<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>imapsync-web-admin</title>
    <link rel="stylesheet" href="/static/css/styles.css" />
    <script src="/static/js/tailwind.js"></script>
    <script src="/static/js/htmx.min.js"
        integrity="sha384-xcuj3WpfgjlKF+FXhSQFQ0ZNr39ln+hwjN3npfM9VBnUskLolQAcN80McRIVOPuO"
        crossorigin="anonymous"></script>
    <script defer src="/static/js/cdn.min.js"></script>

    <style>
        html,
        .navbar,
        body,
        thead {
            transition: background-color .2s ease;
        }
    </style>
</head>

<!-- Admin Panel for viewing the queue and other stats -->

<body x-data="{ model_open: '' }">
    <!-- Header -->
    {{template "admin_navbar.html"}}

    <!-- Table for showing the queue -->
    <div class="container p-4 mx-auto flex gap-4">
        <div class=" flex w-full overflow-x-auto flex-col">
            <h2 class="text-4xl m-2">Queue</h2>

            <!-- Page controls -->
            <div id="pagination" class="pagination m-2" hx-get="/api/pagination?page=1" hx-trigger="load"></div>

            <table class="table-hover table-compact table" id="queue-table" hx-get="/api/queue?page=1" hx-trigger="load"
                hx-target="#table-body" hx-swap-oob="innerHTML transition:true">
                {{template "table.html" .}}
            </table>
        </div>
    </div>


    <div class="modal w-screen" id="detailsmodal" :class="model_open ? 'visible opacity-100' : '' ">
        {{ template "log_window.html"}}
    </div>

    <script>
        var toggleDark = document.getElementById("theme-dark-toggle");
        var toggleLight = document.getElementById("theme-light-toggle");

        var storedTheme =
            localStorage.getItem("theme") ||
            (window.matchMedia("(prefers-color-scheme: dark)").matches
                ? "dark"
                : "light");
        if (storedTheme)
            document.documentElement.setAttribute("data-theme", storedTheme);
        if (storedTheme === "dark") {
            toggleDark.classList.add("dropdown-active");
            toggleLight.classList.remove("dropdown-active");
        } else {
            toggleLight.classList.add("dropdown-active");
            toggleDark.classList.remove("dropdown-active");
        }

        function darkMode() {
            document.documentElement.setAttribute("data-theme", "dark");
            toggleDark.classList.add("dropdown-active");
            toggleLight.classList.remove("dropdown-active");
            localStorage.setItem("theme", "dark");
        }

        function lightMode() {
            document.documentElement.setAttribute("data-theme", "light");
            toggleLight.classList.add("dropdown-active");
            toggleDark.classList.remove("dropdown-active");
            localStorage.setItem("theme", "light");
        }

        toggleDark.addEventListener("click", darkMode, false);
        toggleLight.addEventListener("click", lightMode, false);


        let currentBtn = null;

        const updateButtons = (buttons) => {
            buttons.forEach((button) => {
                if (!button.id.startsWith('sync')) {
                    return;
                }
                button.addEventListener('click', () => {
                    if (currentBtn) {
                        currentBtn.classList.remove('btn-primary');
                    }
                    button.classList.add('btn-primary');
                    currentBtn = button;
                    let currentBtnIndex = button.id.replace('sync', '');
                    htmx.ajax('GET', `/api/pagination?page=${currentBtnIndex}`, '#pagination');
                });
            });
        };

        const listener = htmx.on('htmx:afterSwap', (evt) => {
            const buttons = document.querySelectorAll('.btn');
            updateButtons(buttons);
        });

        var searchInput = document.getElementById("search-input");

        function updateHxTrigger() {
            var table = document.getElementById("table-body");
            if (searchInput.value) {
                table.removeAttribute("hx-trigger");
                htmx.process(table);
            } else {
                table.setAttribute("hx-trigger", "every 2s");
                htmx.process(table);
            }
        }
    </script>

</body>

</html>